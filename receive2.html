<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WebRTC TEST</title>
    <style>
        video {
            object-fit: cover;
        }
    </style>
</head>

<body>
    <video id="video" autoplay="autoplay" controls="controls" style="width:480px;height:640px">
    </video>
    <button id="start" onclick="start()">看直播</button>
    <div id="log"></div>
    <script src="./peer.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.18/peer.min.js"></script> -->
    <!-- <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-5422922-2', 'imququ.com');
        ga('send', 'pageview');
    </script> -->
    <script>
        (function() {
            var video = document.getElementById('video');
            var log = function(msg) {
                document.getElementById('log').innerHTML += msg + '<br />';
            };

            var clientId = (+new Date).toString(36) + '_' + (Math.random().toString()).split('.')[1];

            var peer = new Peer(clientId, {
                host: 'qgy18.com',
                port: 443,
                path: '/',
                config: {
                    'iceServers': [{
                        url: 'stun:stun.l.google.com:19302'
                    }]
                }
            });

            var serverId = location.search.replace('?', '');

            if (!serverId) {
                alert('没有找到直播信源！');
                location.href = 'server.html';
                return;
            }

            var conn = peer.connect(serverId);

            log('连接直播信源中...');
            conn.on('open', function() {
                log('请求连接（' + clientId + '）...');
                conn.send(clientId);
            });

            peer.on('call', function(call) {
                console.log(call)
                call.answer();
                log('自动应答！');
                call.on('stream', function(remoteStream) {
                    console.log(remoteStream)
                    log('播放中...');

                    if (window.URL) {
                        video.srcObject = remoteStream;
                    } else {
                        video.srcObject = remoteStream;
                    }
                });

                call.on('close', function() {
                    log('连接被关闭！');
                });
            });

            function start() {
                video.play();
            }
        })();
    </script>

</body>

</html>